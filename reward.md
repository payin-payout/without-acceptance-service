## Запрос на создание счёта

Для создания счёта нужно отправить POST - запрос на адрес
https://lk.payin-payout.net/service-of-services/create-reward-invoice указав следующие параметры:

|Параметр|Значение|Описание|
|---|---|---|
|service_id   | Целое число, например 1111   |Идентификатор сервиса (средства будут списываться с пользователя привязанного к сервису) |
|receiver_id   | Целое число, например 12345   |Получатель средств  |
|amount   | Число, например 10000   |Сумма в рублях на которую требуется пополнить баланс   |
|external_id   |Строка, например invoice_12345   |Идентификатор счёта, позднее он будет передан в колбеке информирующем о результате обработки счёта   |
|descr   | Описание платежа  |Описание платежа |
|timestamp   | Целое число, время Unix в секундах | [Текущее время Unix](calculate-hash.md#Метка-текущего-времени-в-параметрах) в секундах в UTC |
|user_id   | Целое число, например 12345   |Пользователь который ведёт работу с API |
|hash   | Строка  |[Хэш безопасности](calculate-hash.md)   |

### Пример запроса реализованный на PHP

```php
<?php

$paramPost = [
    'service_id' => 40, // с пользователя привязанного к этому сервису будут списываться средства
    'receiver_id' => 1111, // получатель средств
    'amount' => 10.10,
    'external_id' => 'external_1',
    'description' => 'description',
    'timestamp' => time(),
    'user_id' => 2222, // пользователь который ведёт работу с API
];
uksort($paramPost, 'strcasecmp');
$data_string = http_build_query($paramPost, '', '&');
$hash = hash_hmac('md5', $data_string, 'qwerty');
$paramPost['hash'] = $hash;
$curl = curl_init();
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HTTPHEADER, [
    'Accept: application/json' // чтобы получить ошибку в случае её возникновения в json
]);
curl_setopt($curl, CURLOPT_POST, true);
curl_setopt($curl, CURLOPT_POSTFIELDS, $paramPost);
curl_setopt($curl, CURLOPT_URL, 'https://lk.payin-payout.net/service-of-services/create-reward-invoice');
$out = curl_exec($curl);
echo "\nout:\n$out";
$error = curl_error($curl);
echo "\nerror:\n$error";
```

В случае корректного запроса возвращается ответ:

```json
{
  "status": true,
  "result": true,
  "tracker": " gid_5f3a2084352fc8.99122147"
}
```

# Обработка уведомления о выплате

После обработки выплаты присылается запрос с уведомлением о результате отработки счёта.

Запрос передаётся методом POST, в payload содержится json c данными:

```json
{
  "external_id": "123457",
  "service_id": 111,
  "status": 1,
  "timestamp": "1558429736",
  "tracker": " gid_5cc2ef06c3df02.75425240",
  "payment_in_id": "011111-000082",
  "payment_out_id": "022222-001244",
  "hash": "473840febb4861ec18ce09ccdea09fd5"
}
```

При обработке данных в целях безопасности следует проверить подпись, которая 
[формируется аналогично](calculate-hash.md) случаю с отправкой данных в систему Payin-payout.

Из расчёта исключаются параметры hash и tracker.

Запрос передаётся на адрес который необходимо сообщить менеджменту системы Payin-payout на этапе
создания сервиса.

### Данные передаваемые при уведомлении

|Параметр|Значение|Описание|
|---|---|---|
|external_id   | Строка   |Идентификатор платежа на стороне магазина который [был передан ранее](create-without-acceptance-invoice.md#Данные-передаваемые-при-создании-платежа) при создании счёта  |
|service_id   | Целое число   |Идентификатор сервиса в рамках которого был создан платёж   |
|status   |Целое число, возможные значения 1, 3, 4   |Статус платежа. 1 - успешно оплачен, 3 - у плательщика недостаточно средств чтобы оплатить счёт, 4 - ошибка, необходимо обратиться за помощью к менеджменту системы Payin-payout   |
|payment_in_id  |Строка вида хххххх-уууууу, например 011111-000082 |Идентификатор входящего платежа в рамках которого зачислились средства в личном кабинете владельца магазина |
|payment_out_id  |Строка вида хххххх-уууууу, например 022222-000082 |Идентификатор исходящего платежа в рамках которого списались средства в личном кабинете плательщика, справочная информация на случай пояснений плательщику |
|timestamp   | Целое число, время Unix в секундах | [Текущее время Unix](calculate-hash.md#Метка-текущего-времени-в-параметрах) в секундах в UTC |

### Метка текущего времени в параметрах

При обработке уведомления необходимо проверять корректность timestamp которое не должно существенно
отличаться от текущего времени. Это необходимо для избежания либо некорректных запросов, либо запросов
отправляемых злоумышленниками которые каким-либо образом смогли получить данные ранее отправленных запросов.

### Ответ на уведомление

В случае успешной обработки уведомления система партнёра должна вернуть HTTP код 200 и json
в котором будет присутствовать параметр result со значением true:

```json
{ 
  "result": true
}
```

Если будет получен другой ответ, то будет считаться что система партнёра не смогла корректно
обработать уведомление и позднее будет совершена повторная попытка.

### Повторные уведомления

Учитывая указанное выше система партнёров должна быть готова к тому что уведомление о успешном зачислении
по одному и тому же платежу может отправляться более одного раза и это не должно приводить к
многократным зачислениям. 
