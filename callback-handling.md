# Обработка уведомления о результате обработки автоматически оплачиваемого счёта

После обработки счёта для автоматической оплаты магазину присылается запрос с уведомлением
о результате отработки платежа.

Запрос передаётся методом POST, в payload содержится json c данными:

```json
{
  "external_id": "123457",
  "service_id": 111,
  "status": 1,
  "tracker": " gid_5cc2ef06c3df02.75425240",
  "payment_in_id": "011111-000082",
  "payment_out_id": "022222-001244",
  "timestamp": "1558429736",
  "hash": "473840febb4861ec18ce09ccdea09fd5"
}
```

При обработке данных в целях безопасности следует проверить подпись, которая 
[формируется аналогично](calculate-hash.md) случаю с отправкой данных в систему Payin-payout.

Из расчёта исключаются параметры hash и tracker.

Запрос передаётся на адрес который необходимо сообщить менеджменту системы Payin-payout на этапе
подключения магазина к сервису безакцептного списания.

### Данные передаваемые при уведомлении

|Параметр|Значение|Описание|
|---|---|---|
|external_id   | Строка   |Идентификатор платежа на стороне магазина который [был передан ранее](create-without-acceptance-invoice.md#Данные-передаваемые-при-создании-платежа) при создании счёта  |
|service_id   | Целое число   |Идентификатор сервиса в рамках которого был создан платёж   |
|status   |Целое число, возможные значения 1, 3, 4   |Статус платежа. 1 - успешно оплачен, 3 - у плательщика недостаточно средств чтобы оплатить счёт, 4 - ошибка, необходимо обратиться за помощью к менеджменту системы Payin-payout   |
|payment_in_id  |Строка вида хххххх-уууууу, например 011111-000082 |Идентификатор входящего платежа в рамках которого зачислились средства в личном кабинете владельца магазина |
|payment_out_id  |Строка вида хххххх-уууууу, например 022222-000082 |Идентификатор исходящего платежа в рамках которого списались средства в личном кабинете плательщика, справочная информация на случай пояснений плательщику |
|timestamp   | Целое число, время Unix в секундах | [Текущее время Unix](calculate-hash.md#Метка-текущего-времени-в-параметрах) в секундах в UTC |

### Метка текущего времени в параметрах

При обработке уведомления необходимо проверять корректность timestamp которое не должно существенно
отличаться от текущего времени. Это необходимо для избежания либо некорректных запросов, либо запросов
отправляемых злоумышленниками которые каким-либо образом смогли получить данные ранее отправленных запросов.

### Ответ на уведомление

В случае успешной обработки уведомления система партнёра должна вернуть HTTP код 200 и json
в котором будет присутсвовать параметр result со значением true:

```json
{ 
  "result": true
}
```

Если будет получен другой ответ, то будет считаться что система партнёра не смогла корректно
обработать уведомление и позднее будет совершена повторная попытка.

### Повторные уведомления

Учитывая указанное выше система партнёров должна быть готова к тому что уведомление о успешном зачислении
по одному и тому же платежу может отправляться более одного раза и это не должно приводить к
многократным зачислениям. 
