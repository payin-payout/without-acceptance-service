# Выставление счёта для пополнения баланса

В случае если пользователь имеет баланс недостаточный для оплаты услуги он должен пополнить свой
баланс (проверить баланс пользователя [можно данным запросом](get-balance.md)).

Для пополнения баланса пользователя (который затем используется для автоматических списаний)
пользователь должен либо самостоятельно создать счёт, либо счёт можно создать для него
запросом на метод API.

## Запрос на создание счёта

Для создания счёта нужно отправить POST - запрос на адрес
https://lk.payin-payout.net/payment-in/create-invoice указав следующие параметры:

|Параметр|Значение|Описание|
|---|---|---|
|user_id   | Целое число, например 1111   |Идентификатор пользователя который осуществляет работу с API   |
|payer_id   | Целое число, например 12345   |Идентификатор пользователя счёт которого требуется пополнить  |
|summ   | Число, например 10000   |Сумма в рублях на которую требуется пополнить баланс   |
|currency_id   | Идентификатор валюты   |Трёхзначный цифровой идентификатор согласно ISO 4217 |
|descr   | Описание платежа  |Описание платежа |
|timestamp   | Целое число, время Unix в секундах | [Текущее время Unix](calculate-hash.md#Метка-текущего-времени-в-параметрах) в секундах в UTC |
|id_pref | Целое число (необязательный параметр) | [Выбранный способ оплаты](https://github.com/payin-payout/payin-api#Коды-типов-платежей), если этот параметр выбран, пользователь может миновать этап выбора способа оплаты |
|success_url | Строка (необязательный параметр) |Адрес на который будет перенаправлен пользовать в случае успешной оплаты|
|fail_url | Строка (необязательный параметр) |Адрес на который будет перенаправлен пользовать в случае если оплата не будет успешной|
|is_sos_topup | Логическое значение (необязательный параметр) |Указывает относится ли счёт к сервису безакцепта, требуется для [отправки уведомления](callback-topup-handling.md)|
|hash   | Строка  |[Хэш безопасности](calculate-hash.md)   |

### Пример запроса реализованный на PHP

```php
<?php

$paramPost = [
    'user_id' => 7026,
    'payer_id' => 6034,
    'summ' => 10,
    'currency_id' => 643,
    'timestamp' => time(),
    'is_sos_topup' => true,
    'descr' => '123',
];
uksort($paramPost, 'strcasecmp');
$data_string = http_build_query($paramPost, '', '&');
$hash = hash_hmac('md5', $data_string, 'some_key');
$paramPost['hash'] = $hash;
$curl = curl_init();
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curl, CURLOPT_HEADER, true);
curl_setopt($curl, CURLOPT_POST, true);
curl_setopt($curl, CURLOPT_POSTFIELDS, $paramPost);
curl_setopt($curl, CURLOPT_URL, 'https://lk.payin-payout.net/payment-in/create-invoice');
$out = curl_exec($curl);
echo "\nout:\n$out";
$error = curl_error($curl);
echo "\nerror:\n$error";
```

В случае корректного запроса возвращается ответ:

```json
{
  "status": true,
  "result": {
    "pay_link": "https://lk.payin-payout.net/api/pay/64471022258145#/index",
    "payment_in_id": 64471022258145,
    "payment_in_inner_id": 166,
    "payment_in_inner_id_user": 6034,
    "pretty_id": "006034-000166"
  },
  "tracker": " gid_5ed74ae21dc095.01924744"
}
```

### Описание данных в ответе

|Параметр|Значение|Описание|
|---|---|---|
|status   | логическое значения   |определяет успешность операции  |
|pay_link   |текстовая строка   |ссылка по которой нужно перейти пользователю для оплаты  |
|payment_in_id   |строка   |идентификатор платежа   |
|payment_in_inner_id   |строка   |идентификатор платежа в контексте пользователя которому выставлен счёт|
|payment_in_inner_id_user   |строка   |идентификатор пользователя которому выставлен счёт|
|pretty_id   |строка   |идентификатор счёта|
|tracker   |строка   |служебная информация   |

